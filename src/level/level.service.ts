import { Injectable, OnModuleInit } from '@nestjs/common';
import * as TelegramBot from 'node-telegram-bot-api';
import { ConfigService } from '@nestjs/config';
import { InjectRepository } from '@nestjs/typeorm';
import { Trigger } from '../trigger/trigger.entity';
import { Response } from '../response/response.entity';
import { Repository } from 'typeorm';
import { User } from 'src/user/user.entity';
import { Rank } from 'src/rank/rank.entity';

@Injectable()
export class LevelService implements OnModuleInit {
  private bot: TelegramBot;

  constructor(
    private configService: ConfigService,
    @InjectRepository(Trigger)
    private triggerRepository: Repository<Trigger>,
    @InjectRepository(Response)
    private responseRepository: Repository<Response>,
    @InjectRepository(User) private userRepository: Repository<User>,
    @InjectRepository(Rank) private rankRepository: Repository<Rank>,
  ) {}

  onModuleInit() {
    const token = this.configService.get<string>('TELEGRAM_BOT_TOKEN');
    this.bot = new TelegramBot(token, { polling: true });

    this.bot.onText(/\/—Å–∞–ª–∞–º –∞–ª–µ–π–∫—É–º/i, (msg) => this.handleHelloCommand(msg));
    this.bot.onText(/–Ω–µ—Ç/i, (msg) => this.handleNotCommand(msg));

    this.bot.onText(/\/register/, (msg) => this.handleRegisterCommand(msg));
    this.bot.onText(/\/level/, (msg) => this.handleLevelCommand(msg));
  }

  private handleHelloCommand(msg: TelegramBot.Message) {
    const chatId = msg.chat.id;
    const userName = msg.from?.first_name;
    const stickerId =
      'CAACAgIAAxkBAAEJ9OtnMkohjJgmcFabTQeMq-qspPdQGQACPkkAAhK7OEi_HNN0ZlYtITYE';

    this.bot.sendMessage(chatId, `${userName}, —Å–∞–ª–∞–º –∞–ª–µ–π–∫—É–º! üëãüèø`);
    this.bot.sendSticker(chatId, stickerId);
  }

  private async handleNotCommand(msg: TelegramBot.Message) {
    const chatId = msg.chat.id;

    const trigger = await this.triggerRepository.findOne({
      where: {
        phrase: '–Ω–µ—Ç',
      },
      relations: ['responses'],
    });

    // console.log(trigger);

    if (trigger && trigger.responses.length > 0) {
      const randomResponse =
        trigger.responses[Math.floor(Math.random() * trigger.responses.length)];
      console.log(randomResponse);
      this.bot.sendMessage(chatId, randomResponse.response);
    } else {
      this.bot.sendMessage(chatId, '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞');
    }
  }

  private async handleRegisterCommand(msg: TelegramBot.Message) {
    const chatId = msg.chat.id;
    const userName = msg.from?.username || msg.from?.first_name || 'User';
    const rank = await this.rankRepository.findOne({ where: { id: 1 } });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    const existingUser = await this.userRepository.findOne({
      where: [{ name: userName }],
    });
    console.log(existingUser);
    if (existingUser) {
      this.bot.sendMessage(
        chatId,
        `–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã, ${existingUser.name}!`,
      );
      return;
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const newUser = this.userRepository.create({
      chatId,
      name: userName,
      rank: rank,
    });
    await this.userRepository.save(newUser);

    this.bot.sendMessage(
      chatId,
      `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${userName}! –í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å.`,
    );
  }

  private async handleLevelCommand(msg: TelegramBot.Message) {
    const chatId = msg.chat.id;
    const userName = msg.from?.username || msg.from?.first_name || 'User';

    // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–º–µ–Ω–∏
    const user = await this.userRepository.findOne({
      where: [{ name: userName }],
      relations: ['rank'],
    });
    console.log(user);
    if (!user) {
      this.bot.sendMessage(
        chatId,
        '–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /register, —á—Ç–æ–±—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.',
      );
      return;
    }

    this.bot.sendMessage(
      chatId,
      `${user.name}, –≤–∞—à —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å: ${user.rank.title}`,
    );
  }
}
